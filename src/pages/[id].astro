---
import Layout from '../layouts/Layout.astro';

export async function getStaticPaths() {
  const res = await fetch('https://api.jikan.moe/v4/top/anime');
  const { data } = await res.json();

  return data.slice(0, 10).map(anime => ({
    params: { id: anime.mal_id.toString() },
    props: { anime },
  }));
}

const { anime } = Astro.props;
const title = anime.title;
const description = anime.synopsis;
const image = anime.images.jpg.large_image_url;
const genres = anime.genres.map(g => g.name).join(', ');
const year = anime.year || "Desconocido";
const episodes = anime.episodes || "N/A";
const duration = anime.duration || "N/A";
const trailerUrl = anime.trailer?.url;
---

<Layout title={title}>
  <div class="detalle">
    <div class="detalle__container">
      <img src={image} alt={title} class="detalle__imagen" />
      <div class="detalle__contenido">
        <h1>{title}</h1>
        <p class="detalle__descripcion">{description}</p>
        <p class="detalle__autor">Escrito por Tsugumi Ohba</p>

        <button id="calificacionBtn">Calificación</button>
        <div id="estrellas" style="display: none;">⭐️⭐️⭐️⭐️⭐️</div>

        <div class="detalle__botones">
          <button id="episodiosBtn" data-episodios={episodes}>Cant. epi</button>
          <button id="duracionBtn" data-duracion={duration}>Min. total</button>
        </div>

        <div class="detalle__botones-secundarios">
          <button id="miLista">Añadir a mi lista</button>
          {trailerUrl && (
            <a href={trailerUrl} target="_blank">
              <button>Ver trailer</button>
            </a>
          )}
        </div>

        <div class="detalle__extras">
          <button>{genres}</button>
          <button>{year}</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const starsBtn = document.getElementById('calificacionBtn');
      const estrellas = document.getElementById('estrellas');
      const epiBtn = document.getElementById('episodiosBtn');
      const durBtn = document.getElementById('duracionBtn');
      const listaBtn = document.getElementById('miLista');

      starsBtn?.addEventListener('click', () => {
        estrellas.style.display = 'block';
      });

      epiBtn?.addEventListener('click', () => {
        const totalEpisodios = epiBtn.getAttribute('data-episodios');
        epiBtn.innerText = totalEpisodios + ' epi';
      });

      durBtn?.addEventListener('click', () => {
        const duracion = durBtn.getAttribute('data-duracion');
        durBtn.innerText = duracion;
      });

      listaBtn?.addEventListener('click', () => {
        listaBtn.innerText = listaBtn.innerText === 'Añadir a mi lista' ? 'Añadido' : 'Añadir a mi lista';
      });
    });
  </script>
</Layout>
